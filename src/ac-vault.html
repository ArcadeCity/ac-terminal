<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<script src="scripts/lightwallet.min.js"></script>
<dom-module id="ac-vault">

  <template>
    <iron-localstorage
      id="localstorage"
      name="ac-vault"
      value="{{acvault}}">
    </iron-localstorage>
  </template>

  <script>
    Polymer({

      is: 'ac-vault',

      properties: {
        password: {
          type: String,
          observer: '_password'
        },

        keystore: {
          type: Object,
        },
        currentkeystore: {
          type: Object,
        },
        currentaccount: {
          type: String
        },
        currentidentity: {
          type: Object,
          observer: '_identity'
        }
      },

      _password: function(){

      },
      _currentidentity: function(){
        console.log('ac-vault ->','currentidentity updated',this.currentidentity);
      },

      loadVault: function(){

        try{
          switch (acvault.version){
            case 1:
              this.keystore = keystore.deserialize(acvault.keystore);
              this.currentaccount = this.keystore.getAddresses()[0];
              this.currentidentity = acvault.identity;
              break;
            default:
              throw new Error('Vault version unknown',acvault.version);
              break;
          }
        }
        catch(e){
          throw new Error('Vault could not be loaded',e);
        }
        

      },

      importPrivateKey: function(pk) {
        var self = this;
        this._getpwDerivedKey(function(err, pwDerivedKey) {
          self.keystore.importPrivateKey(pk, pwDerivedKey);
        });
      },

      saveVault: function(){

          var serializedKeystore = this.keystore.serialize();
          var serializedIdentity = JSON.stringify(currentidentity || {});


          var vault = {
            version:1,
            keystore: serializedKeystore,
            identity: serializedIdentity
          };
        
//encryption.multiEncryptString(keystore, pwDerivedKey, msg, myPubKey, theirPubKeyArray [, hdPathString])

          this.set('ac-vault', vault);

      },

      createVault: function(_password, fn) {
        if (!_password){
            throw new Error('no password set for creating Vault');
        }

        var self = this;
        lightwallet.keystore.createVault({
          password: _password,
        }, function(err, ks) {
          self.keystore = ks;
          self.generateNewAddress();
          self._currentAccount();
          self.currentidentity = {
            version:1,
            username: 'MrArc',
            avatarurl: 'https://pbs.twimg.com/profile_images/2431469361/Wc0d22FE_400x400'
          };

          //this.$.localStorage.setItem('ac-avatar', JSON.stringify(self.currentidentity));

          self.saveVault();

          this.ks.passwordProvider = function(callback) {
            callback(null, self.uploadpassword);
          };

          fn();
        });

      },

      _getpwDerivedKey: function(cb){
        if (this.pwDerivedKey){
          return cb(null,this.pwDerivedKey);
        }
        var self=this;
        self.keystore.keyFromPassword(self.password, function(err, pwDerivedKey) {
            if (err){
              return cb(err);
            }
            self.pwDerivedKey = pwDerivedKey;
            cb(null,self.pwDerivedKey);
            //if (err) throw err;
            // if (self.pastedpk) {
            //   //debugger;
            //   self.self.keystore.importPrivateKey(self.pastedpk,pwDerivedKey)
            // } else {
            //self.keystore.generateNewAddress(pwDerivedKey, 1);
            // }

            //var private = self.ks.exportPrivateKey(self.account, pwDerivedKey);
            ///self.private = private;

          });
      },

      generateNewAddress: function(amount) {
        if (!this.keystore) {
          throw new Error('no keystore available');
        }
        var self = this;
        this._getpwDerivedKey(function(err,pwDerivedKey ) {
          self.keystore.generateNewAddress(pwDerivedKey, amount || 1);
        });
      },

      _currentAccount: function(){
        var addr = this.keystore.getAddresses();
        if (addr.length>0){
          this.currentaccount = self.fixaddress(addr[0]);
        }
      }
    });
  </script>
</dom-module>
