<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- <link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html"> -->
<link rel="import" href="./ac-helpers.html">
<script src="scripts/lightwallet.min.js"></script>
<dom-module id="ac-vault">

  <template>
    <ac-helpers id="helpers"></ac-helpers>

  <!--   <iron-localstorage
      id="localstorage"
      name="ac-vault"
      value="{{acvault}}">
    </iron-localstorage> -->
  </template>

  <script>
    Polymer({

      is: 'ac-vault',

      properties: {
        password: {
          type: String,
          observer: '_password'
        },

        keystore: {
          type: Object,
          notify: true,
        },
        currentkeystore: {
          type: Object,
          notify: true,
        },
        currentaccount: {
          type: String,
          notify: true,
        },
        currentidentity: {
          type: Object,
          notify: true,
          //observer: '_identity'
        }
      },

      attached: function(){
        console.log('ac-vault attached');
      },

      _password: function(){

      },

      _currentidentity: function(){
        console.log('ac-vault ->','currentidentity updated',this.currentidentity);
      },

      loadVault: function(password){

        this.vault = JSON.parse(window.localStorage.getItem('ac-vault'));

        try{
          if(!this.vault){
            throw new Error('vault is not defined.');
          }
          switch (this.vault.version){
            case 1:
              this.password = password;
              this.keystore = lightwallet.keystore.deserialize(this.vault.keystore);
              this.currentaccount = this.$.helpers.fixaddress(this.keystore.getAddresses()[0]);
              this.currentidentity = this.vault.identity;
              console.log('ac-vault -> Vault opened. Account=',this.currentaccount);
              break;
            default:
              throw new Error('Vault version unknown',this.vault.version);
              break;
          }
        }
        catch(e){
          throw new Error('Vault could not be loaded',e);
        }

      },

      importPrivateKey: function(pk) {
        var self = this;
        this._getpwDerivedKey(function(err, pwDerivedKey) {
          self.keystore.importPrivateKey(pk, pwDerivedKey);
        });
      },

      saveVault: function(){

          var serializedKeystore = this.keystore.serialize();
          var serializedIdentity = this.currentidentity || {};

          var vault = {
            version:1,
            keystore: serializedKeystore,
            identity: serializedIdentity
          };

//encryption.multiEncryptString(keystore, pwDerivedKey, msg, myPubKey, theirPubKeyArray [, hdPathString])

          window.localStorage.setItem('ac-vault', JSON.stringify(vault));

      },

      hasVault: function(){
        var vault = window.localStorage.getItem('ac-vault');
        return (vault);
      },

      createVault: function(_password, fn) {
        if (!_password) {
          throw new Error('no password set for creating Vault');
        }

        this.password = _password;

        var self = this;
        lightwallet.keystore.createVault({
          password: _password,
        }, function(err, ks) {
          if (err) {
            throw new Error(err);
          }
          self.keystore = ks;
          self.generateNewAddress(1,function() {
            //self._currentAccount();

            self.currentidentity = {
              version: 1,
              username: 'MrArc',
              avatarurl: 'https://pbs.twimg.com/profile_images/2431469361/Wc0d22FE_400x400'
            };

            self.saveVault();
            self.loadVault();

            if (fn) {
              fn();
            }

          });


        });

      },

      _getpwDerivedKey: function(cb){
        if (this.pwDerivedKey){
          return cb(null,this.pwDerivedKey);
        }
        if (!this.password){
          throw new Error('no password set');
        }
        var self=this;
        self.keystore.keyFromPassword(self.password, function(err, pwDerivedKey) {
            if (err){
              return cb(err);
            }
            self.pwDerivedKey = pwDerivedKey;
            cb(null,pwDerivedKey);
            //if (err) throw err;
            // if (self.pastedpk) {
            //   //debugger;
            //   self.self.keystore.importPrivateKey(self.pastedpk,pwDerivedKey)
            // } else {
            //self.keystore.generateNewAddress(pwDerivedKey, 1);
            // }

            //var private = self.ks.exportPrivateKey(self.account, pwDerivedKey);
            ///self.private = private;

          });
      },

      generateNewAddress: function(amount,cb) {
        if (!this.keystore) {
          throw new Error('no keystore available');
        }
        var self = this;
        this._getpwDerivedKey(function(err,pwDerivedKey ) {
          self.keystore.generateNewAddress(pwDerivedKey, amount || 1);
//          var a = self.keystore.getAddresses();
          cb();
//          debugger;
        });
      },

      _currentAccount: function(){
        var addr = this.keystore.getAddresses();
        if (addr.length>0){
          this.currentaccount = self.fixaddress(addr[0]);
        }
      }
    });
  </script>
</dom-module>
