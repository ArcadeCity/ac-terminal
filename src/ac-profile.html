<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">

<link rel="import" href="../bower_components/ac-style/ac-style.html">
<link rel="import" href="../bower_components/ac-button/ac-button.html">
<link rel="import" href="../bower_components/ac-icon/ac-icon.html">
<link rel="import" href="../bower_components/ac-input/ac-input.html">

<link rel="import" href="ac-sizeview.html">
<link rel="import" href="ac-avatar.html">
<link rel="import" href="ac-ipfsupload.html">
<link rel="import" href="ac-ipfs.html">
<link rel="import" href="ac-shortcode.html">

<link rel="stylesheet" href="../bower_components/Croppie/croppie.css" />
<script src="../bower_components/Croppie/croppie.js"></script>

<dom-module id="ac-profile">
  <!-- Defines the element's style and local DOM -->
  <template>
    <style>
  :host {
    display: block;
    width: 100%;
    height: 100%;
  }

  h1 {
    @apply(--ac-font-h1);
  }

  p {
    @apply(--ac-font-body1);
  }

  .total {
    display: block;
    width: 100%;
    height: 100%;
    background-color: var(--ac-base);
    /*overflow-y: scroll;*/
  }

  .whitespace {
    width: 100%;
    height: 20px;
  }

  .profilepic {
    width: 100%;
    box-sizing: border-box;
    padding: 6vh 0px 2vh 0px;
    @apply(--layout-vertical);
    @apply(--layout-center-center);
    /*border-bottom: 2px dotted rgba(255,255,255,0.05);*/
  }

  .profilepicinner {
    @apply(--layout-vertical);
    @apply(--layout-center-justified);
    @apply(--layout-end);
  }

  .profilepicinner ac-button {
    margin-top: -20px;
  }

  .uploadbtn {

  }

  .profileusername {
    width: 100%;
    box-sizing: border-box;
    padding: 0vh 0px 2vh 0px;
    @apply(--layout-vertical);
    @apply(--layout-center-center);
    border-bottom: 2px dotted rgba(255,255,255,0.05);
  }


  .profileusername ac-input {
    width: 60%;
    max-width: 260px;
    overflow: hidden;
  }

  .profileusername p {
    color: white;
  }

  .scrollcontainer {
    width: 100%;
    background-color: var(--ac-base);
  }

  .confirmbtns {
    width: 100%;
    box-sizing: border-box;
    padding: 0px;
    @apply(--layout-horizontal);
    @apply(--layout-center-center);
  }

  .confirmbtns ac-button {
    margin: 2px;
  }

  .confirmbtns ac-icon {
    margin-right: 4px;
  }

  .topback {
    width: 100%;
    background-color: var(--ac-base);
    box-sizing: border-box;
    padding: 5vh 0px 0px 5vw;
    opacity: 0.5;
  }

  .shortcode {
    width: 100%;
    @apply(--layout-vertical);
    @apply(--layout-center-center);
    border-bottom: 2px dotted rgba(255,255,255,0.05);
    box-sizing: border-box;
    padding: 2vh 0px 2vh 0px;
  }

  .pubkey {
    width: 100%;
    @apply(--layout-vertical);
    @apply(--layout-center-center);
    border-bottom: 2px dotted rgba(255,255,255,0.05);
    box-sizing: border-box;
    padding: 3vh 0px 3vh 0px;
  }

  .pubkey p {
    display: inline-block;
    font-size: 12px;
    line-height: 14px;
    color: var(--ac-blue);
    word-break: break-all;
    text-align: center;
    opacity: 0.7;
    padding-bottom:4px;
    border-bottom: 1px dashed var(--ac-blue);
  }

  .logoutbtn {
    width: 100%;
    @apply(--layout-vertical);
    @apply(--layout-center-center);
    box-sizing: border-box;
    padding: 5vh 0px 3vh 0px;
  }

  .logoutbtn ac-button {
    width: 150px;
    @apply(--base-shadow);
  }

  .avataredit {
    height: 300px;
  }
  .hidden {
    display:none;
  }

  neon-animated-pages {
    height: 100vh;
  }

  </style>

    <ac-ipfs id="ipfs"></ac-ipfs>

    <div class="total">
      <div class="topback">
        <ac-icon icon="ac-arrowleft" iconcolor="yellow" on-tap="exit" small>back</ac-icon>
      </div>

      <neon-animated-pages class="avataredit" selected="{{datastate}}" attr-for-selected="data-state">

        <neon-animatable data-state="view">
          <div class="profilepic" on-tap="uploadfile">
            <div class="profilepicinner">

              <ac-avatar
            id="currentavatar"
            username="{{identity.username}}"
            artwork="{{currentavatar}}"
            pubkey="{{account}}"
            mode="imgbigonly"></ac-avatar>

              <input type="file" class="hidden" id="avatarupload" on-change="avatarChange"/>

            </div>
          </div>

          <div class="profileusername">
            <ac-input color="white" label="username" type="input" on-change="usernameChange" bind-value="{{username}}" center inputvalue="MrArcade"></ac-input>
            <iron-collapse id="collapse" opened="{{datachanged}}">
              <div class="confirmbtns">
                <ac-icon icon="ac-decline" iconcolor="yellow" on-tap="exit" small>decline</ac-icon>
                <ac-button icon="ac-v" txtcolor="yellow" bg="btncolor" on-tap="confirm" small>confirm</ac-button>
              </div>
            </iron-collapse>
            <div class="whitespace"></div>
            <!--  <div class="shortcode">
            <ac-shortcode bg="btncolor" txtcolor="white" small>shortcode</ac-shortcode>
          </div>
          -->
          <div class="logoutbtn">
            <ac-button on-tap="logout" txtbtn txtcolor="blue" bg="btncolor" small>log out</ac-button>
          </div>
        </div>
      </neon-animatable>

      <neon-animatable data-state="edit">
        <div class="profilepic">
          <div class="profilepicinner">
            <div id="croppie"></div>
            <ac-button on-tap="setcurrentavatar_cancel" txtbtn txtcolor="blue" bg="btncolor" small>cancel</ac-button>
            <ac-button on-tap="setcurrentavatar" txtbtn txtcolor="blue" bg="btncolor" small>save</ac-button>
          </div>
        </div>
      </neon-animatable>

    </neon-animated-pages>
  </div>

</template>

<script>
  Polymer({
    is: 'ac-profile',
    properties: {
      identity: {
        type: String,
        observer: '_identity',
        notify: true
      },
      datachanged: {
        type: Boolean,
        value: false
      }
    },

    ready: function() {
      this.datastate = 'view';
    },

    init: function(cb){
      this.username = this.identity.username;
      this.avatarhash = this.identity.avatarhash;
      if (cb) cb();
    },

    uploadfile: function() {
      document.querySelector('#avatarupload').click();
    },

    usernameChange: function() {
      this.identity.username = this.username;
      this.datachanged = true;
    },

    avatarChange: function(e) {
      var input = e.target;
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
          this.toCropper(e.target.result);
        }.bind(this);
        reader.readAsDataURL(input.files[0]);
      }
    },

    _is: function(a, b) {
      if (b === undefined) {
        b = true;
      }
      return a === b;
    },

    // receive identity from data binder
    _identity: function() {
      this.currentavatar = this.identity.avatarurl;
    },

    toCropper: function(image) {
      this.datastate = 'edit';
      this.currentavatar = image;
      if (this.croppie && this.croppie.destroy) {
        this.croppie.destroy();
      }
      this.croppie = new Croppie(this.$.croppie, {
        viewport: {
          width: 100,
          height: 100
        },
        boundary: {
          width: 300,
          height: 300
        },
        showZoomer: false
          //enableOrientation: true
      });
      this.croppie.bind({
        url: image,
        orientation: 4
      });
    },

    setcurrentavatar_cancel: function() {
      this.datastate = 'view';
      self.croppie.destroy();
    },

    setcurrentavatar: function() {
      var self = this;
      this.croppie.result({
        type: 'base64',
        format: 'jpeg',
        quality: 0.9
      }).then(function(base64) {

        // set the avatar to the dataURL.
        this.currentavatar = base64;
        this.datastate = 'view';

        // now convert and save to IPFS in the background.
        var base64data = base64.replace(/^data:image\/(png|jpg|jpeg);base64,/, '');
        var imgbuffer = this.$.ipfs.ipfs.Buffer(base64data, 'base64');

        this.$.ipfs.add(imgbuffer, function(err, result) {
          console.log(err, result[0].hash);
          var hashurl = this.$.ipfs.geturl(result[0].hash);
          self.identity.avatarurl = hashurl;
          self.datachanged = true;
          self.fire('identity-update',self.identity);
        }.bind(this));

        // remove cropper
        self.croppie.destroy();
        self.datachanged = true;

      }.bind(this));

    },

    _sizeview: function() {
      switch (this.sizeview) {
        case 'phone':
          this.align = 'verticcenter';
          this.customStyle['--avatar-size'] = '90px';
          this.updateStyles();
          break;
        case 'desktop':
          this.align = 'verticstart';
          this.customStyle['--avatar-size'] = '130px';
          this.updateStyles();
          break;
        case 'xlarge':
          this.align = 'verticstart';
          this.customStyle['--avatar-size'] = '130px';
          this.updateStyles();
          break;
        default:
          console.log("!!! ** Niks");
      }
    },

    logout: function() {
      this.fire('logout');
//      sessionStorage.removeItem('ac-password');
//      window.location = '/';
    },

    _username: function() {
      //console.log(this.username);
      // if (this.username != this.identity.username) {
      //   var collapser = document.getElementById('collapse');
      //   collapser.show();
      // }
      // if (this.username == this.identity.username) {
      //   var collapser = document.getElementById('collapse');
      //   collapser.hide();
      // }
    },

    exit: function(){      
      this.datastate = 'view';
      this.datachanged = false;
      this.fire('exit');
    },

    confirm: function() {
      this.set('identity.username', this.username);
      this.datachanged = false;
      this.fire('identity-update',this.identity);
      this.fire('exit');
    },

    // savenewUsername: function() {
    //   var collapser = document.getElementById('collapse');
    //   console.log("this is it", collapser);
    //   collapser.toggle();
    // },

    // backtohome: function() {
    //   this.datastate = 'view';
    //   this.fire('exit');
    // },

    // toggleupload: function() {
    //   this.$.ipfsupload.click();
    // }

  });
</script>

</dom-module>